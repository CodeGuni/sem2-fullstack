<% /*
 * File: g.ejs
 * Author: Gunpreet Singh
 * Student ID: 9022194
 * Purpose: Renders the G test page for drivers to update car info, book appointments, and view results.
 */ %> 
 <% if (message) { %>
  <div class="alert <%= message.includes('Error') ? 'alert-danger' : 'alert-success' %> alert-dismissible fade show">
    <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="card">
  <div class="card-header">G License Information</div>
  <div class="card-body">
    <h4>Please confirm your information</h4>
    <p>First Name: <%= user.firstname %></p>
    <p>Last Name: <%= user.lastname %></p>
    <p>Age: <%= user.age %></p>
    <p>License Number: <%= user.licenseNo %></p>

    <% if (bookedAppointment) { %>
      <hr>
      <h5>Your Booked Appointment</h5>
      <p>
        Date: <%= new Date(bookedAppointment.date).toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        }) %>
        <br>
        Time: <%= bookedAppointment.time %>
      </p>
    <% } else { %>
      <hr>
      <h5>Your Booked Appointment</h5>
      <p>No appointment booked yet.</p>
    <% } %>

    <form method="POST" action="/g/update">
      <div class="card mb-3">
        <div class="card-header">Update Car Details</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="carMake" class="form-label">Make</label>
              <input type="text" class="form-control" id="carMake" name="carMake" value="<%= user.car_details.make === 'default' ? '' : user.car_details.make %>">
            </div>
            <div class="col-md-3 mb-3">
              <label for="carModel" class="form-label">Model</label>
              <input type="text" class="form-control" id="carModel" name="carModel" value="<%= user.car_details.model === 'default' ? '' : user.car_details.model %>">
            </div>
            <div class="col-md-3 mb-3">
              <label for="carYear" class="form-label">Year</label>
              <input type="number" class="form-control" id="carYear" name="carYear" min="1886" value="<%= user.car_details.year === 0 ? '' : user.car_details.year %>">
            </div>
            <div class="col-md-3 mb-3">
              <label for="platNumber" class="form-label">Plate Number</label>
              <input type="text" class="form-control" id="platNumber" name="platNumber" value="<%= user.car_details.platno === 'default' ? '' : user.car_details.platno %>">
            </div>
          </div>
          <button type="submit" class="btn btn-success">Update Car Information</button>
        </div>
      </div>
    </form>

    <hr>
    <h5>Book Appointment</h5>
    <% if (bookedAppointment) { %>
      <div class="alert alert-info">
        You have already booked a slot:
        <strong>
          <%= new Date(bookedAppointment.date).toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
          }) %> - <%= bookedAppointment.time %>
        </strong>
      </div>
      <h6>Reschedule Appointment</h6>
      <form method="POST" action="/g/reschedule" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="appointmentDate" class="form-label">Select Date</label>
          <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
          <div class="invalid-feedback">Please select a date.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Available Slots</label>
          <select class="form-control" name="appointmentId" id="appointmentSlots" required>
            <option value="">Select a time slot</option>
            <% appointments.forEach(appointment => { %>
              <option value="<%= appointment._id %>">
                <%= appointment.date.toDateString() %> - <%= appointment.time %>
              </option>
            <% }) %>
          </select>
          <div class="invalid-feedback">Please select an appointment slot.</div>
        </div>
        <button type="submit" class="btn btn-warning">Reschedule Appointment</button>
      </form>
    <% } else { %>
      <div class="mb-3">
        <label for="appointmentDate" class="form-label">Select Date</label>
        <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
        <div class="invalid-feedback">Please select a date.</div>
      </div>
      <form method="POST" action="/g/book" class="needs-validation" novalidate>
        <div class="mb-3">
          <label class="form-label">Available Slots</label>
          <select class="form-control" name="appointmentId" id="appointmentSlots" required>
            <option value="">Select a time slot</option>
            <% appointments.forEach(appointment => { %>
              <option value="<%= appointment._id %>">
                <%= appointment.date.toDateString() %> - <%= appointment.time %>
              </option>
            <% }) %>
          </select>
          <div class="invalid-feedback">Please select an appointment slot.</div>
        </div>
        <button type="submit" class="btn btn-success">Book Appointment</button>
      </form>
    <% } %>

    <% if (user.examinerComment || user.passFail !== null) { %>
      <hr>
      <h5>Test Results</h5>
      <div class="card">
        <div class="card-body">
          <p><strong>Examiner Comment:</strong> <%= user.examinerComment || 'No comment provided' %></p>
          <p><strong>Result:</strong> <%= user.passFail === true ? 'Pass' : user.passFail === false ? 'Fail' : 'Not evaluated' %></p>
        </div>
      </div>
    <% } %>
  </div>
</div>

<script>
  document.getElementById('appointmentDate').addEventListener('change', async function() {
    const selectedDate = this.value;
    if (!selectedDate) return;

    try {
      const response = await fetch(`/g/available-slots?date=${selectedDate}`);
      const availableSlots = await response.json();
      const select = document.getElementById('appointmentSlots');
      select.innerHTML = '<option value="">Select a time slot</option>';
      if (availableSlots.length > 0) {
        availableSlots.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot._id;
          option.text = `${new Date(slot.date).toDateString()} - ${slot.time}`;
          select.appendChild(option);
        });
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.text = 'No available slots for this date';
        select.appendChild(option);
      }
    } catch (err) {
      console.error('Error fetching available slots:', err);
      const select = document.getElementById('appointmentSlots');
      select.innerHTML = '<option value="">Error loading slots</option>';
    }
  });
</script>
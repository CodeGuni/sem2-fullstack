<% layout('layout/main') %>

<% if (message) { %>
  <div class="alert <%= message.includes('Error') ? 'alert-danger' : 'alert-success' %> alert-dismissible fade show">
    <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<form method="POST" action="/g2" class="needs-validation" novalidate>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="firstName" class="form-label">First Name</label>
      <input type="text" class="form-control" id="firstName" name="firstName" value="<%= user.firstname === 'default' ? '' : user.firstname %>" required>
      <div class="invalid-feedback">First Name is required.</div>
    </div>
    <div class="col-md-6 mb-3">
      <label for="lastName" class="form-label">Last Name</label>
      <input type="text" class="form-control" id="lastName" name="lastName" value="<%= user.lastname === 'default' ? '' : user.lastname %>" required>
      <div class="invalid-feedback">Last Name is required.</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="licenseNumber" class="form-label">License Number</label>
      <input type="text" class="form-control" id="licenseNumber" name="licenseNumber" pattern="[A-Za-z0-9]{8}" maxlength="8" value="<%= user.licenseNo === 'default' ? '' : user.licenseNo %>" required>
      <small class="form-text text-muted">8 alphanumeric characters</small>
      <div class="invalid-feedback">License Number must be 8 alphanumeric characters.</div>
    </div>
    <div class="col-md-6 mb-3">
      <label for="age" class="form-label">Age</label>
      <input type="number" class="form-control" id="age" name="age" min="16" value="<%= user.age === 0 ? '' : user.age %>" readonly required>
      <div class="invalid-feedback">Age must be 16 or older.</div>
    </div>
  </div>

  <div class="mb-3">
    <label for="dob" class="form-label">Date of Birth</label>
    <input type="date" class="form-control" id="dob" name="dob" value="<%= user.dob ? user.dob.toISOString().split('T')[0] : '' %>" required>
    <div class="invalid-feedback">Date of Birth is required.</div>
  </div>

  <div class="card mb-3">
    <div class="card-header">Car Details</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label for="carMake" class="form-label">Make</label>
          <input type="text" class="form-control" id="carMake" name="carMake" value="<%= user.car_details.make === 'default' ? '' : user.car_details.make %>">
        </div>
        <div class="col-md-3 mb-3">
          <label for="carModel" class="form-label">Model</label>
          <input type="text" class="form-control" id="carModel" name="carModel" value="<%= user.car_details.model === 'default' ? '' : user.car_details.model %>">
        </div>
        <div class="col-md-3 mb-3">
          <label for="carYear" class="form-label">Year</label>
          <input type="number" class="form-control" id="carYear" name="carYear" min="1886" value="<%= user.car_details.year === 0 ? '' : user.car_details.year %>">
        </div>
        <div class="col-md-3 mb-3">
          <label for="platNumber" class="form-label">Plate Number</label>
          <input type="text" class="form-control" id="platNumber" name="platNumber" value="<%= user.car_details.platno === 'default' ? '' : user.car_details.platno %>">
        </div>
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-primary">Update Information</button>
</form>

<hr>
<h5>Book Appointment</h5>
<% if (bookedAppointment) { %>
  <div class="alert alert-info">
    You have already booked a slot:
    <strong>
      <%= new Date(bookedAppointment.date).toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      }) %> - <%= bookedAppointment.time %>
    </strong>
  </div>
  <h6>Reschedule Appointment</h6>
  <form method="POST" action="/g2/reschedule" class="needs-validation" novalidate>
    <div class="mb-3">
      <label for="appointmentDate" class="form-label">Select Date</label>
      <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
      <div class="invalid-feedback">Please select a date.</div>
    </div>
    <div class="mb-3">
      <label class="form-label">Available Slots</label>
      <select class="form-control" name="appointmentId" id="appointmentSlots" required>
        <option value="">Select a time slot</option>
        <% appointments.forEach(appointment => { %>
          <option value="<%= appointment._id %>">
            <%= appointment.date.toDateString() %> - <%= appointment.time %>
          </option>
        <% }) %>
      </select>
      <div class="invalid-feedback">Please select an appointment slot.</div>
    </div>
    <button type="submit" class="btn btn-warning">Reschedule Appointment</button>
  </form>
<% } else { %>
  <div class="mb-3">
    <label for="appointmentDate" class="form-label">Select Date</label>
    <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
    <div class="invalid-feedback">Please select a date.</div>
  </div>
  <form method="POST" action="/g2/book" class="needs-validation" novalidate>
    <div class="mb-3">
      <label class="form-label">Available Slots</label>
      <select class="form-control" name="appointmentId" id="appointmentSlots" required>
        <option value="">Select a time slot</option>
        <% appointments.forEach(appointment => { %>
          <option value="<%= appointment._id %>">
            <%= appointment.date.toDateString() %> - <%= appointment.time %>
          </option>
        <% }) %>
      </select>
      <div class="invalid-feedback">Please select an appointment slot.</div>
    </div>
    <button type="submit" class="btn btn-success">Book Appointment</button>
  </form>
<% } %>

<% if (user.examinerComment || user.passFail !== null) { %>
  <hr>
  <h5>Test Results</h5>
  <div class="card">
    <div class="card-body">
      <p><strong>Examiner Comment:</strong> <%= user.examinerComment || 'No comment provided' %></p>
      <p><strong>Result:</strong> <%= user.passFail === true ? 'Pass' : user.passFail === false ? 'Fail' : 'Not evaluated' %></p>
    </div>
  </div>
<% } %>

<script>
  document.getElementById('dob').addEventListener('change', function() {
    const dob = new Date(this.value);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    document.getElementById('age').value = age >= 0 ? age : '';
  });

  document.getElementById('appointmentDate').addEventListener('change', async function() {
    const selectedDate = this.value;
    if (!selectedDate) return;

    try {
      const response = await fetch(`/g2/available-slots?date=${selectedDate}`);
      const availableSlots = await response.json();
      const select = document.getElementById('appointmentSlots');
      select.innerHTML = '<option value="">Select a time slot</option>';
      if (availableSlots.length > 0) {
        availableSlots.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot._id;
          option.text = `${new Date(slot.date).toDateString()} - ${slot.time}`;
          select.appendChild(option);
        });
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.text = 'No available slots for this date';
        select.appendChild(option);
      }
    } catch (err) {
      console.error('Error fetching available slots:', err);
      const select = document.getElementById('appointmentSlots');
      select.innerHTML = '<option value="">Error loading slots</option>';
    }
  });
</script>